name: Tag when workflows change

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Comment if workflow files changed
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner, repo, pull_number, per_page: 100
            });

            const changed = files.map(f => f.filename)
              .filter(p => p.startsWith('.github/workflows/'));

            if (changed.length === 0) {
              core.info('No workflow files changed. No comment.');
              return;
            }

            const TAG = '@andijakl';
            const MARKER = '<!--workflow-change-notice-->';
            const lines = [
              MARKER,
              `${TAG} Heads-up: GitHub Actions workflow files were changed in this PR.`,
              '',
              'Changed files:',
              ...changed.map(f => `- \`${f}\``),
              '',
              '> This is an automated notice. CODEOWNERS will still request your review if configured.'
            ];
            const body = lines.join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number: pull_number, per_page: 100
            });

            const existing = comments.find(c => c.body?.includes(MARKER));
            if (existing) {
              await github.rest.issues.updateComment({
                owner, repo, comment_id: existing.id, body
              });
              core.info('Updated existing workflow-change comment.');
            } else {
              await github.rest.issues.createComment({
                owner, repo, issue_number: pull_number, body
              });
              core.info('Created workflow-change comment.');
            }
