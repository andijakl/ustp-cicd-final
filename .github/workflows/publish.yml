name: Publish to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      target_sha:
        description: "Commit SHA to deploy (leave empty = use this workflow's SHA)"
        required: false
        default: "" # must be a literal, not an expression [1](https://github.com/orgs/community/discussions/25218)
      build_workflow:
        description: "Build workflow file (path in .github/workflows)"
        required: false
        default: build.yml

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true
jobs:
  publish:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Resolve successful Build run for SHA
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            const wfFile =
              (context.payload.inputs && context.payload.inputs.build_workflow) ||
              'build.yml';

            const sha =
              (context.payload.inputs && context.payload.inputs.target_sha) ||
              context.sha;

            // Get workflow by file name
            const { data: workflow } = await github.rest.actions.getWorkflow({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: wfFile,
            });

            // Find the most recent successful run of that workflow for this SHA
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow.id,
              head_sha: sha,
              status: 'success',
              per_page: 50,
            });

            if (!runs.workflow_runs?.length) {
              core.setFailed(`No successful '${wfFile}' run found for SHA ${sha}`);
              return;
            }

            core.setOutput('run_id', runs.workflow_runs[0].id);
            core.setOutput('sha', sha);

      - name: Download build artifact (vite-build-<sha>) from Build workflow
        uses: actions/download-artifact@v4
        with:
          name: vite-build-${{ steps.resolve.outputs.sha }}
          run-id: ${{ steps.resolve.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: dist

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
